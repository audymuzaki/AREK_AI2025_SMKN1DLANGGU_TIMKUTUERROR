<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Pengaduan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #e0f2f1; /* soft teal */
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }

    /* Navbar */
    .navbar {
      background: linear-gradient(90deg, #004d40, #00695c);
    }
    .navbar .btn-danger {
      font-weight: 600;
      transition: 0.3s;
    }
    .navbar .btn-danger:hover {
      transform: scale(1.05);
    }

    /* Card utama */
    .card {
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      animation: fadeInCard 0.8s forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes fadeInCard {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Table */
    table tbody tr {
      transition: 0.3s;
      cursor: pointer;
    }
    table tbody tr:hover {
      background: rgba(0,77,64,0.05);
    }

    .small-img {
      width:60px;
      height:60px;
      object-fit:cover;
      border-radius:8px;
      cursor:pointer;
      transition: transform 0.3s;
    }
    .small-img:hover {
      transform: scale(1.1);
    }

    .modal-content {
      border-radius: 16px;
      overflow: hidden;
      animation: fadeInModal 0.5s forwards;
    }

    @keyframes fadeInModal {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }

    /* Tombol */
    .btn-primary, .btn-success {
      border-radius: 10px;
      transition: 0.3s;
    }
    .btn-primary:hover, .btn-success:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark mb-4">
  <div class="container-fluid d-flex justify-content-between">
    <span class="navbar-brand h1 text-white">Admin Panel Pengaduan</span>
    <div class="text-white">
      <span id="adminName" class="me-3 fw-bold"></span>
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="card p-4 shadow mb-4">
    <h3 class="mb-3 text-center text-dark">Daftar Laporan Masuk</h3>
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle" id="laporanTable"></table>
    </div>
  </div>
</div>

<!-- Modal Preview Foto -->
<div class="modal fade" id="modalFoto" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-3">
        <img id="previewFoto" src="" class="img-fluid rounded" alt="Preview Foto">
      </div>
    </div>
  </div>
</div>

<!-- Modal Kirim Respon -->
<div class="modal fade" id="modalRespon" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kirim Respon Admin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Respon</label>
          <textarea id="inputRespon" class="form-control" rows="4" placeholder="Tulis respon..."></textarea>
        </div>
        <div class="mb-2">
          <label class="form-label">Lampirkan Foto (Wajib)</label>
          <input type="file" id="fotoAdmin" class="form-control" accept="image/*">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnKirimRespon">Kirim Respon</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Lihat Respon -->
<div class="modal fade" id="modalLihatRespon" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Respon Admin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body" id="isiRespon"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="btnHapusLaporan">Hapus</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let laporan = JSON.parse(localStorage.getItem("laporanPengaduan")) || [];
let selectedIndexForResponse = null;
let currentIndexForModal = null;

/* CEK LOGIN ADMIN */
// if (!localStorage.getItem("isAdmin")) window.location.href = "login.html";

/* TAMPILKAN NAMA ADMIN */
document.getElementById("adminName").innerText = localStorage.getItem("loggedName") || "Admin";

/* LOGOUT */
function logout() {
  localStorage.removeItem("isAdmin");
  localStorage.removeItem("adminEmail");
  window.location.href = "login.html";
}

/* RENDER TABEL LAPORAN */
function renderTable() {
  const table = document.getElementById("laporanTable");
  table.innerHTML = `
    <thead class="table-light">
      <tr>
        <th>Nama Pelapor</th>
        <th>Lokasi Kejadian</th>
        <th>Laporan</th>
        <th>Bukti Laporan</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody>
      ${
        laporan.length === 0
          ? `<tr><td colspan="6" class="text-center text-muted py-4">Belum ada laporan</td></tr>`
          : laporan.map((lap, idx) => `
          <tr>
            <td>${lap.nama}</td>
            <td>${lap.alamat}</td>
            <td>${lap.deskripsi}</td>
            <td class="text-center">
              ${
                lap.foto
                  ? `<img src="${lap.foto}" class="small-img" onclick="previewFoto('${lap.foto}')">`
                  : `<span class="text-muted">Tidak ada foto</span>`
              }
            </td>
            <td>${lap.respon ? "Sudah direspon" : "Belum direspon"}</td>
            <td>
              ${
                lap.respon
                  ? `<button class="btn btn-success btn-sm" onclick="lihatRespon(${idx})">Lihat Respon</button>`
                  : `<button class="btn btn-primary btn-sm" onclick="bukaRespon(${idx})">Kirim Respon</button>`
              }
            </td>
          </tr>`).join("")
      }
    </tbody>
  `;
}

/* PREVIEW FOTO BESAR */
function previewFoto(src) {
  document.getElementById("previewFoto").src = src;
  new bootstrap.Modal(document.getElementById("modalFoto")).show();
}

/* BUKA MODAL KIRIM RESPON */
function bukaRespon(i) {
  selectedIndexForResponse = i;
  document.getElementById("inputRespon").value = laporan[i].respon || "";
  document.getElementById("fotoAdmin").value = "";
  new bootstrap.Modal(document.getElementById("modalRespon")).show();
}

/* SIMPAN RESPON */
document.getElementById("btnKirimRespon").addEventListener("click", () => {
  const text = document.getElementById("inputRespon").value.trim();
  const file = document.getElementById("fotoAdmin").files[0];

  if (!text) return alert("Respon tidak boleh kosong!");
  if (!file) return alert("Foto wajib dilampirkan!");

  const reader = new FileReader();
  reader.onload = e => saveResponse(text, e.target.result);
  reader.readAsDataURL(file);
});

function saveResponse(text, fotoAdmin) {
  const idx = selectedIndexForResponse;
  laporan[idx].respon = text;
  laporan[idx].foto_admin = fotoAdmin;
  laporan[idx].tanggal_respon = new Date().toLocaleString("id-ID");
  localStorage.setItem("laporanPengaduan", JSON.stringify(laporan));

  bootstrap.Modal.getInstance(document.getElementById("modalRespon")).hide();
  renderTable();
}

/* LIHAT RESPON */
function lihatRespon(i) {
  currentIndexForModal = i;
  const d = laporan[i];

  document.getElementById("isiRespon").innerHTML = `
    <p><strong>Nama Pelapor:</strong> ${d.nama}</p>
    <p><strong>Lokasi Kejadian:</strong> ${d.alamat}</p>
    <p><strong>Tanggal Respon:</strong> ${d.tanggal_respon}</p>
    <p><strong>Respon Admin:</strong><br>${d.respon}</p>
    <hr>
    <strong>Bukti Laporan:</strong><br>
    <img src="${d.foto_admin}" class="img-fluid rounded mt-2">
  `;

  new bootstrap.Modal(document.getElementById("modalLihatRespon")).show();
}

/* HAPUS LAPORAN */
document.getElementById("btnHapusLaporan").addEventListener("click", () => {
  if (!confirm("Yakin ingin menghapus laporan ini?")) return;
  laporan.splice(currentIndexForModal, 1);
  localStorage.setItem("laporanPengaduan", JSON.stringify(laporan));
  bootstrap.Modal.getInstance(document.getElementById("modalLihatRespon")).hide();
  renderTable();
});

renderTable();
</script>

</body>
</html>